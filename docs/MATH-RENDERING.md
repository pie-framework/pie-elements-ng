# Math Rendering in pie-elements-ng

**Last Updated:** 2026-02-01
**Status:** ✅ Production Ready (MathJax v4)

## Overview

pie-elements-ng uses **MathJax v4** as the default math renderer, providing:
- ✅ Full accessibility (Speech Rule Engine, WCAG AAA)
- ✅ Native MathML rendering (100% fidelity)
- ✅ ESM-compatible (unlike MathJax v3)
- ✅ LaTeX support (all standard packages)
- ✅ CDN-based loading (~2.7MB, cached)

## Architecture

### Wrapper Pattern

```
@pie-lib/math-rendering (wrapper)
  └─> @pie-element/shared-math-rendering-mathjax (~2.7MB via CDN)
      └─> MathJax v4 library
```

The wrapper maintains API compatibility with upstream `@pie-lib/math-rendering` while allowing internal implementation changes.

### Key Packages

1. **`@pie-lib/math-rendering`** - Wrapper package (re-exports from adapter)
   - Location: `packages/lib-react/math-rendering/`
   - Auto-generated by sync system
   - Maintains upstream API compatibility

2. **`@pie-element/shared-math-rendering-mathjax`** - MathJax v4 adapter
   - Location: `packages/shared/math-rendering-mathjax/`
   - Loads MathJax v4 from CDN
   - Full accessibility support

3. **`@pie-element/shared-math-rendering-katex`** - KaTeX adapter (legacy)
   - Location: `packages/shared/math-rendering-katex/`
   - Lightweight alternative (~100KB)
   - Available for special use cases

4. **`@pie-element/shared-math-rendering-core`** - Core types
   - Location: `packages/shared/math-rendering-core/`
   - `MathRenderer` interface
   - Shared utilities

## Usage

### For Element Developers

Use the standard wrapper (recommended):

```typescript
import { renderMath } from '@pie-lib/math-rendering';

// Call after DOM updates
queueMicrotask(() => {
  renderMath(this); // Renders all math in element
});
```

### For Player Developers

Use the factory function for dependency injection:

```typescript
import { createMathjaxRenderer } from '@pie-element/shared-math-rendering-mathjax';
import type { MathRenderer } from '@pie-element/shared-math-rendering-core';

const mathRenderer: MathRenderer = createMathjaxRenderer({
  accessibility: true,       // Enable Speech Rule Engine
  useSingleDollar: false,    // Disable $...$ delimiters
  loadFonts: true,           // Load MathJax fonts
});

// Pass to element player
await mathRenderer(containerElement);
```

### For Content Authors

**LaTeX (recommended):**
```html
<div>Inline: \(x^2 + y^2 = z^2\)</div>
<div>Display: \[E = mc^2\]</div>
```

**MathML:**
```html
<math>
  <mfrac>
    <msup><mi>x</mi><mn>2</mn></msup>
    <mn>2</mn>
  </mfrac>
</math>
```

## Features

### MathJax v4 Capabilities

- **Full LaTeX Support**: All standard TeX packages (base, ams, autoload)
- **Native MathML**: Direct rendering without conversion
- **Accessibility**:
  - Speech Rule Engine (SRE) for screen readers
  - ARIA labels automatically generated
  - Semantic enrichment
  - Context menus for alternative formats
- **Custom Macros**: parallelogram, overarc, napprox, longdiv
- **Display Modes**: Inline and display math
- **CDN Loading**: Zero bundle impact, cached across elements

### Accessibility Features

MathJax v4 provides WCAG AAA compliance:

1. **Screen Reader Support**
   - Math expressions spoken naturally (e.g., "x squared plus y squared")
   - Multiple verbosity levels
   - Navigate term-by-term

2. **ARIA Integration**
   - Automatic ARIA labels
   - Semantic structure preservation
   - Keyboard navigation (Tab, Arrow keys)

3. **Alternative Formats**
   - Context menu (right-click on math)
   - Copy as LaTeX, MathML, or plain text
   - Zoom functionality

## Comparison with Upstream

| Feature | Upstream (MathJax v3) | pie-elements-ng (MathJax v4) |
|---------|----------------------|------------------------------|
| **Library** | mathjax-full@3.2.2 | @mathjax/src@4.1.0 |
| **Format** | CommonJS | ESM |
| **Bundle** | ~2.7MB bundled | ~2.7MB CDN-loaded |
| **Accessibility** | Full (SRE) | Full (SRE) |
| **MathML** | Native | Native |
| **LaTeX** | Full | Full |
| **ESM Compatible** | ❌ No | ✅ Yes |
| **Tree-shakeable** | ❌ No | ✅ Yes |

## Why MathJax v4?

### Previous Approach (2026-01-30)

Initially used KaTeX wrapper due to MathJax v3 CommonJS incompatibility:
- ✅ Light bundle (~100KB)
- ✅ Fast rendering
- ⚠️ Limited accessibility
- ⚠️ MathML via conversion (fidelity loss)

### Current Approach (2026-02-01)

Switched to MathJax v4 because:
1. **ESM-compatible** - MathJax v4 is pure ESM (unlike v3)
2. **Full accessibility** - Required for WCAG AAA compliance
3. **Native MathML** - 100% rendering fidelity
4. **Same API** - Backward compatible with upstream
5. **CDN loading** - Zero bundle impact in production

## Migration from Upstream

### Automatic Transformation

The sync system automatically transforms imports:

```typescript
// Upstream code (pie-elements)
import { renderMath } from '@pie-lib/math-rendering';

// After sync (pie-elements-ng)
import { renderMath } from '@pie-element/shared-math-rendering-mathjax';
```

Elements copied from upstream work without code changes.

### Sync Configuration

Math rendering transformation configured in:
- `tools/cli/src/lib/upstream/sync-pielib-strategy.ts` - Wrapper generation
- `tools/cli/src/lib/upstream/sync-imports.ts` - Import rewriting
- `tools/cli/src/lib/upstream/sync-package-manager.ts` - Dependency management
- `tools/cli/src/lib/upstream/sync-vite-config.ts` - Build externals

## Performance

### Bundle Size

- **MathJax v4**: ~2.7MB (loaded from CDN once, cached)
- **Per element**: ~200KB (element code only)
- **Total first load**: ~2.9MB (MathJax + element)
- **Subsequent elements**: ~200KB each (MathJax cached)

### Render Speed

- **Initial render**: ~50-100ms (typical content)
- **Re-render**: ~20-30ms (cached math)
- **MathML**: ~30-50ms (native rendering)

### CDN Loading

```javascript
// MathJax loads asynchronously
<script src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-chtml.js"></script>

// Does not block page render
// Cached across all elements on same domain
```

## Troubleshooting

### Math Not Rendering

1. **Check CDN loading**: Open browser console, verify no 404 errors
2. **Verify import**: Element should import from `@pie-element/shared-math-rendering-mathjax`
3. **Check timing**: Call `renderMath()` after DOM updates (use `queueMicrotask`)

### MathML Issues

MathJax v4 renders MathML natively - no conversion needed. If MathML doesn't render:
1. Check XML well-formedness
2. Verify `xmlns` attribute: `<math xmlns="http://www.w3.org/1998/Math/MathML">`
3. Test with simpler MathML first

### Accessibility Not Working

1. **Enable accessibility**: Pass `accessibility: true` to `createMathjaxRenderer()`
2. **Test with screen reader**: Right-click math → should see context menu
3. **Check ARIA labels**: Inspect rendered math for `aria-label` attributes

## Alternative: KaTeX Adapter

For lightweight contexts where full accessibility isn't required:

```typescript
import { createKatexRenderer } from '@pie-element/shared-math-rendering-katex';

const renderer = createKatexRenderer();
await renderer(element);
```

**Use when:**
- Preview/authoring interfaces (internal tools)
- Bundle size is critical
- Content is LaTeX-only (no MathML)
- Basic accessibility is sufficient

**Limitations:**
- MathML via conversion (may lose fidelity)
- No Speech Rule Engine
- Limited screen reader support

## Development

### Building

```bash
# Build math rendering packages
cd packages/shared/math-rendering-mathjax && bun run build
cd packages/lib-react/math-rendering && bun run build
```

### Testing

```bash
# Start demo app
cd apps/element-demo
bun run dev

# Open browser to http://localhost:5222/multiple-choice/deliver
# Math should render with MathJax
```

### Syncing from Upstream

```bash
# Sync all packages (includes math-rendering wrapper)
bun cli upstream:sync

# Wrapper is auto-generated at:
# packages/lib-react/math-rendering/src/index.ts
```

## References

### Code Locations

- Math rendering adapters: `packages/shared/math-rendering-*/`
- Wrapper package: `packages/lib-react/math-rendering/`
- Sync configuration: `tools/cli/src/lib/upstream/sync-*.ts`
- Element player integration: `packages/element-player/src/PieElementPlayer.svelte`

### Documentation

- IIFE bundle architecture: [IIFE-BUNDLE-ARCHITECTURE.md](./IIFE-BUNDLE-ARCHITECTURE.md)
- Accessibility review: Use `/accessibility-reviewer-assessments` skill

### External Resources

- [MathJax v4 Documentation](https://docs.mathjax.org/en/latest/)
- [WCAG 2.2 Guidelines](https://www.w3.org/WAI/WCAG22/quickref/)
- [Speech Rule Engine](https://speechruleengine.org/)

## Migration History

- **2026-01-30**: Initial KaTeX wrapper (ESM compatibility)
- **2026-02-01**: Switched to MathJax v4 (full accessibility)

---

**Questions or Issues?** File an issue or consult the sync system documentation.
